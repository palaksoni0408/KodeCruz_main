{"version":3,"sources":["../../../src/interface/crud/transactions.ts"],"sourcesContent":["import type { InferType } from \"yup\";\nimport {\n  customerTypeSchema,\n  inlineProductSchema,\n  moneyAmountSchema,\n  yupArray,\n  yupBoolean,\n  yupNumber,\n  yupObject,\n  yupString,\n  yupUnion,\n} from \"../../schema-fields\";\nimport { SUPPORTED_CURRENCIES } from \"../../utils/currency-constants\";\nimport { typedFromEntries } from \"../../utils/objects\";\nimport { throwErr } from \"../../utils/errors\";\n\n\nconst USD_CURRENCY = SUPPORTED_CURRENCIES.find((currency) => currency.code === \"USD\") ?? throwErr(\"USD currency configuration missing in SUPPORTED_CURRENCIES\");\n\nconst chargedAmountSchema = yupObject({\n  ...typedFromEntries(SUPPORTED_CURRENCIES.map((currency) => [currency.code, moneyAmountSchema(currency).optional()])),\n}).noUnknown(true).test(\"at-least-one-currency\", \"charged_amount must include at least one currency amount\", (value) => {\n  return Object.values(value).some((amount) => typeof amount === \"string\");\n}).defined();\n\nconst netAmountSchema = yupObject({\n  USD: moneyAmountSchema(USD_CURRENCY).defined(),\n}).noUnknown(true).defined();\n\nconst transactionEntryMoneyTransferSchema = yupObject({\n  type: yupString().oneOf([\"money_transfer\"]).defined(),\n  adjusted_transaction_id: yupString().nullable().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).nullable().defined(),\n  customer_type: customerTypeSchema.defined(),\n  customer_id: yupString().defined(),\n  charged_amount: chargedAmountSchema,\n  net_amount: netAmountSchema,\n}).defined();\n\nconst transactionEntryItemQuantityChangeSchema = yupObject({\n  type: yupString().oneOf([\"item_quantity_change\"]).defined(),\n  adjusted_transaction_id: yupString().nullable().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).nullable().defined(),\n  customer_type: customerTypeSchema.defined(),\n  customer_id: yupString().defined(),\n  item_id: yupString().defined(),\n  quantity: yupNumber().defined(),\n}).defined();\n\nconst transactionEntryProductGrantSchema = yupObject({\n  type: yupString().oneOf([\"product_grant\"]).defined(),\n  adjusted_transaction_id: yupString().nullable().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).nullable().defined(),\n  customer_type: customerTypeSchema.defined(),\n  customer_id: yupString().defined(),\n  product_id: yupString().nullable().defined(),\n  product: inlineProductSchema.defined(),\n  price_id: yupString().nullable().defined(),\n  quantity: yupNumber().defined(),\n  subscription_id: yupString().optional(),\n  one_time_purchase_id: yupString().optional(),\n}).test(\n  \"exclusive-reference\",\n  \"subscription_id and one_time_purchase_id cannot both be set\",\n  (value, context) => {\n    if (value.subscription_id != null && value.one_time_purchase_id != null) {\n      return context.createError({\n        message: \"subscription_id and one_time_purchase_id cannot both be set\",\n      });\n    }\n    return true;\n  },\n).defined();\n\nconst transactionEntryProductRevocationSchema = yupObject({\n  type: yupString().oneOf([\"product_revocation\"]).defined(),\n  adjusted_transaction_id: yupString().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).defined(),\n  quantity: yupNumber().defined(),\n}).defined();\n\nconst transactionEntryProductRevocationReversalSchema = yupObject({\n  type: yupString().oneOf([\"product_revocation_reversal\"]).defined(),\n  adjusted_transaction_id: yupString().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).defined(),\n  quantity: yupNumber().defined(),\n}).defined();\n\nexport const transactionEntrySchema = yupUnion(\n  transactionEntryMoneyTransferSchema,\n  transactionEntryItemQuantityChangeSchema,\n  transactionEntryProductGrantSchema,\n  transactionEntryProductRevocationSchema,\n  transactionEntryProductRevocationReversalSchema,\n).defined();\n\nexport type TransactionEntry = InferType<typeof transactionEntrySchema>;\n\nexport const TRANSACTION_TYPES = [\n  \"purchase\",\n  \"subscription-cancellation\",\n  \"subscription-renewal\",\n  \"manual-item-quantity-change\",\n  \"chargeback\", // todo\n  \"product-change\", // todo\n] as const;\n\nexport type TransactionType = (typeof TRANSACTION_TYPES)[number];\n\nexport const transactionSchema = yupObject({\n  id: yupString().defined(),\n  created_at_millis: yupNumber().defined(),\n  effective_at_millis: yupNumber().defined(),\n  type: yupString().oneOf(TRANSACTION_TYPES).nullable().defined(),\n  entries: yupArray(transactionEntrySchema).defined(),\n  adjusted_by: yupArray(\n    yupObject({\n      transaction_id: yupString().defined(),\n      entry_index: yupNumber().integer().min(0).defined(),\n    }).defined(),\n  ).defined(),\n  test_mode: yupBoolean().defined(),\n}).defined();\n\nexport type Transaction = InferType<typeof transactionSchema>;\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,2BAUO;AACP,gCAAqC;AACrC,qBAAiC;AACjC,oBAAyB;AAGzB,IAAM,eAAe,+CAAqB,KAAK,CAAC,aAAa,SAAS,SAAS,KAAK,SAAK,wBAAS,4DAA4D;AAE9J,IAAM,0BAAsB,gCAAU;AAAA,EACpC,OAAG,iCAAiB,+CAAqB,IAAI,CAAC,aAAa,CAAC,SAAS,UAAM,wCAAkB,QAAQ,EAAE,SAAS,CAAC,CAAC,CAAC;AACrH,CAAC,EAAE,UAAU,IAAI,EAAE,KAAK,yBAAyB,4DAA4D,CAAC,UAAU;AACtH,SAAO,OAAO,OAAO,KAAK,EAAE,KAAK,CAAC,WAAW,OAAO,WAAW,QAAQ;AACzE,CAAC,EAAE,QAAQ;AAEX,IAAM,sBAAkB,gCAAU;AAAA,EAChC,SAAK,wCAAkB,YAAY,EAAE,QAAQ;AAC/C,CAAC,EAAE,UAAU,IAAI,EAAE,QAAQ;AAE3B,IAAM,0CAAsC,gCAAU;AAAA,EACpD,UAAM,gCAAU,EAAE,MAAM,CAAC,gBAAgB,CAAC,EAAE,QAAQ;AAAA,EACpD,6BAAyB,gCAAU,EAAE,SAAS,EAAE,QAAQ;AAAA,EACxD,0BAAsB,gCAAU,EAAE,QAAQ,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ;AAAA,EACtE,eAAe,wCAAmB,QAAQ;AAAA,EAC1C,iBAAa,gCAAU,EAAE,QAAQ;AAAA,EACjC,gBAAgB;AAAA,EAChB,YAAY;AACd,CAAC,EAAE,QAAQ;AAEX,IAAM,+CAA2C,gCAAU;AAAA,EACzD,UAAM,gCAAU,EAAE,MAAM,CAAC,sBAAsB,CAAC,EAAE,QAAQ;AAAA,EAC1D,6BAAyB,gCAAU,EAAE,SAAS,EAAE,QAAQ;AAAA,EACxD,0BAAsB,gCAAU,EAAE,QAAQ,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ;AAAA,EACtE,eAAe,wCAAmB,QAAQ;AAAA,EAC1C,iBAAa,gCAAU,EAAE,QAAQ;AAAA,EACjC,aAAS,gCAAU,EAAE,QAAQ;AAAA,EAC7B,cAAU,gCAAU,EAAE,QAAQ;AAChC,CAAC,EAAE,QAAQ;AAEX,IAAM,yCAAqC,gCAAU;AAAA,EACnD,UAAM,gCAAU,EAAE,MAAM,CAAC,eAAe,CAAC,EAAE,QAAQ;AAAA,EACnD,6BAAyB,gCAAU,EAAE,SAAS,EAAE,QAAQ;AAAA,EACxD,0BAAsB,gCAAU,EAAE,QAAQ,EAAE,IAAI,CAAC,EAAE,SAAS,EAAE,QAAQ;AAAA,EACtE,eAAe,wCAAmB,QAAQ;AAAA,EAC1C,iBAAa,gCAAU,EAAE,QAAQ;AAAA,EACjC,gBAAY,gCAAU,EAAE,SAAS,EAAE,QAAQ;AAAA,EAC3C,SAAS,yCAAoB,QAAQ;AAAA,EACrC,cAAU,gCAAU,EAAE,SAAS,EAAE,QAAQ;AAAA,EACzC,cAAU,gCAAU,EAAE,QAAQ;AAAA,EAC9B,qBAAiB,gCAAU,EAAE,SAAS;AAAA,EACtC,0BAAsB,gCAAU,EAAE,SAAS;AAC7C,CAAC,EAAE;AAAA,EACD;AAAA,EACA;AAAA,EACA,CAAC,OAAO,YAAY;AAClB,QAAI,MAAM,mBAAmB,QAAQ,MAAM,wBAAwB,MAAM;AACvE,aAAO,QAAQ,YAAY;AAAA,QACzB,SAAS;AAAA,MACX,CAAC;AAAA,IACH;AACA,WAAO;AAAA,EACT;AACF,EAAE,QAAQ;AAEV,IAAM,8CAA0C,gCAAU;AAAA,EACxD,UAAM,gCAAU,EAAE,MAAM,CAAC,oBAAoB,CAAC,EAAE,QAAQ;AAAA,EACxD,6BAAyB,gCAAU,EAAE,QAAQ;AAAA,EAC7C,0BAAsB,gCAAU,EAAE,QAAQ,EAAE,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC3D,cAAU,gCAAU,EAAE,QAAQ;AAChC,CAAC,EAAE,QAAQ;AAEX,IAAM,sDAAkD,gCAAU;AAAA,EAChE,UAAM,gCAAU,EAAE,MAAM,CAAC,6BAA6B,CAAC,EAAE,QAAQ;AAAA,EACjE,6BAAyB,gCAAU,EAAE,QAAQ;AAAA,EAC7C,0BAAsB,gCAAU,EAAE,QAAQ,EAAE,IAAI,CAAC,EAAE,QAAQ;AAAA,EAC3D,cAAU,gCAAU,EAAE,QAAQ;AAChC,CAAC,EAAE,QAAQ;AAEJ,IAAM,6BAAyB;AAAA,EACpC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF,EAAE,QAAQ;AAIH,IAAM,oBAAoB;AAAA,EAC/B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA;AAAA,EACA;AAAA;AACF;AAIO,IAAM,wBAAoB,gCAAU;AAAA,EACzC,QAAI,gCAAU,EAAE,QAAQ;AAAA,EACxB,uBAAmB,gCAAU,EAAE,QAAQ;AAAA,EACvC,yBAAqB,gCAAU,EAAE,QAAQ;AAAA,EACzC,UAAM,gCAAU,EAAE,MAAM,iBAAiB,EAAE,SAAS,EAAE,QAAQ;AAAA,EAC9D,aAAS,+BAAS,sBAAsB,EAAE,QAAQ;AAAA,EAClD,iBAAa;AAAA,QACX,gCAAU;AAAA,MACR,oBAAgB,gCAAU,EAAE,QAAQ;AAAA,MACpC,iBAAa,gCAAU,EAAE,QAAQ,EAAE,IAAI,CAAC,EAAE,QAAQ;AAAA,IACpD,CAAC,EAAE,QAAQ;AAAA,EACb,EAAE,QAAQ;AAAA,EACV,eAAW,iCAAW,EAAE,QAAQ;AAClC,CAAC,EAAE,QAAQ;","names":[]}