{"version":3,"sources":["../../../../src/interface/crud/transactions.ts"],"sourcesContent":["import type { InferType } from \"yup\";\nimport {\n  customerTypeSchema,\n  inlineProductSchema,\n  moneyAmountSchema,\n  yupArray,\n  yupBoolean,\n  yupNumber,\n  yupObject,\n  yupString,\n  yupUnion,\n} from \"../../schema-fields\";\nimport { SUPPORTED_CURRENCIES } from \"../../utils/currency-constants\";\nimport { typedFromEntries } from \"../../utils/objects\";\nimport { throwErr } from \"../../utils/errors\";\n\n\nconst USD_CURRENCY = SUPPORTED_CURRENCIES.find((currency) => currency.code === \"USD\") ?? throwErr(\"USD currency configuration missing in SUPPORTED_CURRENCIES\");\n\nconst chargedAmountSchema = yupObject({\n  ...typedFromEntries(SUPPORTED_CURRENCIES.map((currency) => [currency.code, moneyAmountSchema(currency).optional()])),\n}).noUnknown(true).test(\"at-least-one-currency\", \"charged_amount must include at least one currency amount\", (value) => {\n  return Object.values(value).some((amount) => typeof amount === \"string\");\n}).defined();\n\nconst netAmountSchema = yupObject({\n  USD: moneyAmountSchema(USD_CURRENCY).defined(),\n}).noUnknown(true).defined();\n\nconst transactionEntryMoneyTransferSchema = yupObject({\n  type: yupString().oneOf([\"money_transfer\"]).defined(),\n  adjusted_transaction_id: yupString().nullable().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).nullable().defined(),\n  customer_type: customerTypeSchema.defined(),\n  customer_id: yupString().defined(),\n  charged_amount: chargedAmountSchema,\n  net_amount: netAmountSchema,\n}).defined();\n\nconst transactionEntryItemQuantityChangeSchema = yupObject({\n  type: yupString().oneOf([\"item_quantity_change\"]).defined(),\n  adjusted_transaction_id: yupString().nullable().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).nullable().defined(),\n  customer_type: customerTypeSchema.defined(),\n  customer_id: yupString().defined(),\n  item_id: yupString().defined(),\n  quantity: yupNumber().defined(),\n}).defined();\n\nconst transactionEntryProductGrantSchema = yupObject({\n  type: yupString().oneOf([\"product_grant\"]).defined(),\n  adjusted_transaction_id: yupString().nullable().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).nullable().defined(),\n  customer_type: customerTypeSchema.defined(),\n  customer_id: yupString().defined(),\n  product_id: yupString().nullable().defined(),\n  product: inlineProductSchema.defined(),\n  price_id: yupString().nullable().defined(),\n  quantity: yupNumber().defined(),\n  subscription_id: yupString().optional(),\n  one_time_purchase_id: yupString().optional(),\n}).test(\n  \"exclusive-reference\",\n  \"subscription_id and one_time_purchase_id cannot both be set\",\n  (value, context) => {\n    if (value.subscription_id != null && value.one_time_purchase_id != null) {\n      return context.createError({\n        message: \"subscription_id and one_time_purchase_id cannot both be set\",\n      });\n    }\n    return true;\n  },\n).defined();\n\nconst transactionEntryProductRevocationSchema = yupObject({\n  type: yupString().oneOf([\"product_revocation\"]).defined(),\n  adjusted_transaction_id: yupString().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).defined(),\n  quantity: yupNumber().defined(),\n}).defined();\n\nconst transactionEntryProductRevocationReversalSchema = yupObject({\n  type: yupString().oneOf([\"product_revocation_reversal\"]).defined(),\n  adjusted_transaction_id: yupString().defined(),\n  adjusted_entry_index: yupNumber().integer().min(0).defined(),\n  quantity: yupNumber().defined(),\n}).defined();\n\nexport const transactionEntrySchema = yupUnion(\n  transactionEntryMoneyTransferSchema,\n  transactionEntryItemQuantityChangeSchema,\n  transactionEntryProductGrantSchema,\n  transactionEntryProductRevocationSchema,\n  transactionEntryProductRevocationReversalSchema,\n).defined();\n\nexport type TransactionEntry = InferType<typeof transactionEntrySchema>;\n\nexport const TRANSACTION_TYPES = [\n  \"purchase\",\n  \"subscription-cancellation\",\n  \"subscription-renewal\",\n  \"manual-item-quantity-change\",\n  \"chargeback\", // todo\n  \"product-change\", // todo\n] as const;\n\nexport type TransactionType = (typeof TRANSACTION_TYPES)[number];\n\nexport const transactionSchema = yupObject({\n  id: yupString().defined(),\n  created_at_millis: yupNumber().defined(),\n  effective_at_millis: yupNumber().defined(),\n  type: yupString().oneOf(TRANSACTION_TYPES).nullable().defined(),\n  entries: yupArray(transactionEntrySchema).defined(),\n  adjusted_by: yupArray(\n    yupObject({\n      transaction_id: yupString().defined(),\n      entry_index: yupNumber().integer().min(0).defined(),\n    }).defined(),\n  ).defined(),\n  test_mode: yupBoolean().defined(),\n}).defined();\n\nexport type Transaction = InferType<typeof transactionSchema>;\n"],"mappings":"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","names":[]}